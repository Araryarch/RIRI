// Tic Tac Toe (Single Player vs AI)
// Run: rrc run tests/18_qt_tictactoe.rr --qt

print("Starting Tic Tac Toe (vs Bot)...");

let argc = 0;
let app = new QApplication(argc, nullptr);
let doc = new Document();

class GameState {
    board = ["", "", "", "", "", "", "", "", ""]; 
    currentPlayer = "X";
    active = true;
    
    set(idx, val) {
        this.board[idx] = val;
    }
    
    get(idx) {
        return this.board[idx];
    }
    
    switchPlayer() {
        if (this.currentPlayer == "X") { this.currentPlayer = "O"; }
        else { this.currentPlayer = "X"; }
    }
    
    reset() {
        let i = 0;
        while (i < 9) {
            this.board[i] = "";
            i = i + 1;
        }
        this.active = true;
        this.currentPlayer = "X";
    }
}

let game = new GameState();

// UI Setup
let win = doc.createElement("window");
win.setAttribute("title", "Tic Tac Toe (vs Bot)");
win.setAttribute("style", "background-color: #2c3e50; min-width: 300px; min-height: 400px;");

let statusLabel = doc.createElement("label");
statusLabel.setAttribute("text", "Player X's Turn");
statusLabel.setAttribute("style", "font-size: 24px; color: white; padding: 10px; qproperty-alignment: AlignCenter;");
win.appendChild(statusLabel);

let grid = doc.createElement("div");
let row1 = doc.createElement("span");
let row2 = doc.createElement("span");
let row3 = doc.createElement("span");

let b0 = doc.createElement("button");
let b1 = doc.createElement("button");
let b2 = doc.createElement("button");
let b3 = doc.createElement("button");
let b4 = doc.createElement("button");
let b5 = doc.createElement("button");
let b6 = doc.createElement("button");
let b7 = doc.createElement("button");
let b8 = doc.createElement("button");

let btnStyle = "font-size: 24px; font-weight: bold; min-width: 80px; min-height: 80px; margin: 5px; background-color: #ecf0f1; border-radius: 5px; border: none; color: #2c3e50;";

// Helper to update button UI
let updateBtnUI = (index, p) => {
    let btn = b0;
    if (index == 1) { btn = b1; }
    if (index == 2) { btn = b2; }
    if (index == 3) { btn = b3; }
    if (index == 4) { btn = b4; }
    if (index == 5) { btn = b5; }
    if (index == 6) { btn = b6; }
    if (index == 7) { btn = b7; }
    if (index == 8) { btn = b8; }

    btn.setAttribute("text", p);
    if (p == "X") {
        btn.setAttribute("style", btnStyle + " color: #e74c3c;");
    } else {
        btn.setAttribute("style", btnStyle + " color: #3498db;");
    }
};

let checkWin = () => {
    if (game.active == false) { return; }

    let winFound = false;
    let winner = "";
    
    // Rows
    if (game.get(0) != "" && game.get(0) == game.get(1)) { if (game.get(1) == game.get(2)) { winFound = true; winner = game.get(0); } }
    if (game.get(3) != "" && game.get(3) == game.get(4)) { if (game.get(4) == game.get(5)) { winFound = true; winner = game.get(3); } }
    if (game.get(6) != "" && game.get(6) == game.get(7)) { if (game.get(7) == game.get(8)) { winFound = true; winner = game.get(6); } }
    
    // Cols
    if (game.get(0) != "" && game.get(0) == game.get(3)) { if (game.get(3) == game.get(6)) { winFound = true; winner = game.get(0); } }
    if (game.get(1) != "" && game.get(1) == game.get(4)) { if (game.get(4) == game.get(7)) { winFound = true; winner = game.get(1); } }
    if (game.get(2) != "" && game.get(2) == game.get(5)) { if (game.get(5) == game.get(8)) { winFound = true; winner = game.get(2); } }
    
    // Diags
    if (game.get(0) != "" && game.get(0) == game.get(4)) { if (game.get(4) == game.get(8)) { winFound = true; winner = game.get(0); } }
    if (game.get(2) != "" && game.get(2) == game.get(4)) { if (game.get(4) == game.get(6)) { winFound = true; winner = game.get(2); } }
    
    if (winFound) {
        statusLabel.setAttribute("text", "Winner: " + winner + "!");
        game.active = false;
        return;
    }
    
    // Draw logic
    let full = true;
    let i = 0;
    while (i < 9) {
        if (game.get(i) == "") { full = false; }
        i = i + 1;
    }
    if (full) {
        statusLabel.setAttribute("text", "Draw!");
        game.active = false;
    }
};

let computerMove = () => {
    if (game.active == false) {
        return;
    }
    print("Bot thinking...");
    
    // Collect empty spots
    // We cannot use array easily for dynamic list without proper vector support helper (push is tricky)
    // But we can iterate and count, then pick nth empty.
    
    let count = 0;
    let i = 0;
    while (i < 9) {
        if (game.get(i) == "") { count = count + 1; }
        i = i + 1;
    }
    
    if (count == 0) {
        return;
    }
    
    // Random pick
    let pick = rand() % count; // 0 to count-1
    
    // Find that spot
    let current = 0;
    let targetIndex = -1;
    i = 0;
    while (i < 9) {
        if (game.get(i) == "") {
            if (current == pick) {
                targetIndex = i;
            }
            current = current + 1;
        }
        i = i + 1;
    }
    
    if (targetIndex != -1) {
        print("Bot chose index: " + string(targetIndex));
        game.set(targetIndex, "O");
        updateBtnUI(targetIndex, "O");
        checkWin();
        if (game.active) {
            game.switchPlayer(); // Back to X
            statusLabel.setAttribute("text", "Player X's Turn");
        }
    }
};

let setupBtn = (btn, index) => {
    btn.setAttribute("style", btnStyle);
    btn.setAttribute("text", "");
    
    btn.addEventListener("click", () => {
        if (game.active == false) {
            return;
        }
        if (game.currentPlayer != "X") {
            return;
        }
        if (game.get(index) != "") {
            return;
        }
        
        // Player Move
        game.set(index, "X");
        updateBtnUI(index, "X");
        
        checkWin();
        
        if (game.active) {
            game.switchPlayer(); // Switch to O
            statusLabel.setAttribute("text", "Bot is thinking...");
            // Trigger Bot Move
            // In real Qt we might want a timer, but here we just call it.
            computerMove();
        }
    });
};

setupBtn(b0, 0); setupBtn(b1, 1); setupBtn(b2, 2);
setupBtn(b3, 3); setupBtn(b4, 4); setupBtn(b5, 5);
setupBtn(b6, 6); setupBtn(b7, 7); setupBtn(b8, 8);

row1.appendChild(b0); row1.appendChild(b1); row1.appendChild(b2);
row2.appendChild(b3); row2.appendChild(b4); row2.appendChild(b5);
row3.appendChild(b6); row3.appendChild(b7); row3.appendChild(b8);

grid.appendChild(row1);
grid.appendChild(row2);
grid.appendChild(row3);

win.appendChild(grid);

// Reset
let resetBtn = doc.createElement("button");
resetBtn.setAttribute("text", "Reset Game");
resetBtn.setAttribute("style", "padding: 10px; margin: 20px; font-size: 16px; background-color: #95a5a6; color: white; border-radius: 5px;");
resetBtn.addEventListener("click", () => {
    game.reset();
    statusLabel.setAttribute("text", "Player X's Turn");
    
    let resetB = (b) => {
        b.setAttribute("text", "");
        b.setAttribute("style", btnStyle);
    };
    resetB(b0); resetB(b1); resetB(b2);
    resetB(b3); resetB(b4); resetB(b5);
    resetB(b6); resetB(b7); resetB(b8);
});
win.appendChild(resetBtn);

win.show();
print("Tic Tac Toe Running...");
app.exec();
print("ALL TESTS PASSED");
